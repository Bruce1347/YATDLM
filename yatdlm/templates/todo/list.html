{% extends 'todo/base.html' %}
{% load static %}

{% block content %}
    {% csrf_token %}
    {% if not xhr %}
    <input class="hidden" id="dom_list_id" value="{{ list.id }}">
    <input class="hidden" id="dom_ispublicjs" value="{{ publicjs }}">
    <div style="max-width: 40em; margin: auto;" id="todo_header">
        <h1>{{ list.title }}</h1>
        <p style="">Crée par <b>{{ list.owner }}</b> le {{ list.creation_date|date:"d/m/Y à H:i" }}</p>
        <div>
            {{ list.description|display_urls|linebreaks }}
        </div>
        {% if not public %}
        <div>
            <button id="add-task-btn" type="button" onclick="toggle_add_form('add-container', 'add-task-btn');" class="pure-button">Ajouter une tâche</button>
            <button type="button" class="pure-button" onclick="delete_list('/todo/lists/delete/{{ list.id }}', '{{ list.title }}', false, null);">Supprimer la liste</button>
            <button type="button" class="pure-button" onclick="close_details()">Tout refermer</button>
        </div>
        {% endif %}
    </div>
    <div class="margint-normal">
        {% if not public %}
        <div class="marginb-normal hidden" id="add-container">
            <hr>
            <div style="max-width: 40em; margin: auto;">
                <form>
                    <h2>Ajouter une tâche :</h2>
                    <label for="new_task_title">Titre :</label>
                    <input class="marginb-normal" type="text" id="new_task_title" style="width: 100%">
                    <label for="new_task_descr">Description :</label>
                    <textarea class="marginb-normal" id="new_task_descr" rows="8" style="width: 100%"></textarea>
                    <div class="marginb-normal" style="display: flex;">
                        <div style="flex: 1; margin-right: 10px;">
                            <label for="new_task_due_date">Date de fin :</label>
                            <input type="text" id="new_task_due_date" style="width: 100%">
                        </div>
                        <div style="flex: 1; margin-left: 10px;">
                            <label for="new_task_priority">Priorité :</label>
                            <select id="new_task_priority" style="width: 100%;">
                                {% for choice in priority_levels %}
                                {% if choice.0 != 2 %}
                                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                {% else %}
                                <option selected value="{{ choice.0 }}">{{ choice.1 }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <button class="marginb-normal pure-button" type="button" onclick="add_task_exp('/todo/lists/{{ list.id }}/add_task');">Ajouter une nouvelle tâche</button>
                </form>
            </div>
            <hr>
        </div>
        {% endif %}
    {% endif %}
        <div class="marginb-normal">
            <table class="fullwidth pure-table pure-table-bordered" style="max-width: 60em; margin: auto;">
                {% if not search and not xhr %}
                <thead>
                    <tr class="low_black_border">
                        <th class="cell c-align">#</th>
                        <th class="cell c-align">Tâche</th>
                        <th class="cell c-align">Création</th>
                        <th class="cell c-align">Résolution</th>
                        <th class="cell c-align">Échéance</th>
                        <th class="cell c-align" style="max-width: 10%">Priorité</th>
                        {% if not public %}
                        <th class="cell c-align">
                        </th>
                        {% endif %}
                    </tr>
                    <tr>
                        <th>
                            <input class="fullwidth" size="1" pattern="^[0-9]+$|^$" type="text" name="search_tid" id="input_tid">
                        </th>
                        <th>
                            <input class="fullwidth" size="1" type="text" name="search_tname" id="input_tname">
                        </th>
                        <th>
                            <div class="flexdiv">
                                <select class="flex1 marginr-tiny" name="search_tcmonth" id="select_tcmonth">
                                    <option value="-1" label=" " selected></option>
                                    {% for month in months %}
                                    <option value="{{ month.1 }}">{{ month.0 }}</option>
                                    {% endfor %}
                                </select>
                                <select class="flex1 marginl-tiny" name="search_tcyear" id="select_tcyear">
                                    <option value="-1" label=" " selected></option>
                                    {% for year in creation_years %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="flexdiv">
                                <select class="flex1 marginr-tiny" name="search_trmonth" id="select_trmonth">
                                    <option value="-1" label=" " selected></option>
                                    {% for month in months %}
                                    <option value="{{ month.1 }}">{{ month.0 }}</option>
                                    {% endfor %}
                                </select>
                                <select class="flex1 marginl-tiny" name="search_tryear" id="select_tryear">
                                    <option value="-1" label=" " selected></option>
                                    {% for year in resolution_years %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </th>
                        <th>
                            <div class="flexdiv">
                                <select class="flex1 marginr-tiny" name="search_tdmonth" id="select_tdmonth">
                                    <option value="-1" label=" " selected></option>
                                    {% for month in months %}
                                    <option value="{{ month.1 }}">{{ month.0 }}</option>
                                    {% endfor %}
                                </select>
                                <select class="flex1 marginl-tiny" name="search_tdyear" id="select_tdyear">
                                    <option value="-1" label=" " selected></option>
                                    {% for year in deadlines_years %}
                                    <option value="{{ year }}">{{ year }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </th>
                        <th>
                            <select class="fullwidth" name="search_tprio" id="select_tprio" >
                                <option value="-1" label=" " selected></option>
                                {% for choice in priority_levels %}
                                <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        {% if not public %}
                        <th></th>
                        {% endif %}
                    </tr>
                </thead>
                {% endif %}
                <tbody id="list-container">
                    {% for task in tasks %}
                        <tr id="{{ task.task_no }}" class="nowrap priority_{{ task.priority }}">
                            <td class="cell c-align">
                                {{ task.task_no }}
                            </td>
                            <td id="title_{{ task.task_no }}" class="pointer cell l-align" style="white-space: nowrap;">
                                <span title="{{ task.title }}">{{ task.title|truncatechars:40 }}</span>
                            </td>
                            <td class="pointer cell c-align">
                                {{ task.creation_date|date:"d/m/Y" }}
                            </td>
                            {% if task.is_done %}
                                <td id="resolutiond_{{ task.task_no }}" class="pointer cell c-align" colspan="2">
                                    Résolu le {{ task.resolution_date|date:"d/m/Y" }} à {{ task.resolution_date|date:"H:i" }}
                                </td>
                            {% else %}
                                <td id="resolutiond_{{ task.task_no }}" class="pointer cell c-align">
                                {{ task.resolution_date|date:"d/m/Y" }}
                                </td>
                                <td id="dued_{{ task.task_no }}" class="pointer cell c-align">
                                    {{ task.due_date|date:"d/m/Y" }}
                                </td>
                            {% endif %}
                            <td id="priority_{{ task.task_no }}" class="pointer cell c-align" style="white-space: nowrap; padding-left: 1em; padding-right: 1em;">
                                {{ task.get_priority_display }}
                            </td>
                            {% if not public %}
                                <td class="delete pointer cell c-align" style="min-width: 30px;" onclick="del_task('/todo/lists/{{ list.id }}/del_task/{{ task.id }}', {{ task.task_no }});">
                                    <img class="pointer" width="24" height="24"  alt="Delete" src="{% static 'img/icons/garbage_red.svg' %}">
                                </td>
                            {% endif %}
                        </tr>
                        <tr id="task_subline_{{ task.task_no }}" class="hidden b_lightgrey">
                            <td id="task_detail_{{ task.task_no }}" colspan="7">
                                <div class="margint-normal">
                                    <span style="font-size: 1.8em">Tâche #{{ task.task_no }} : {{ task.title }}</span>
                                </div>
                                <div class="marginb-normal">
                                    <span class="b_lightgrey">
                                        Crée le {{ task.creation_date|date:"d/m/Y" }} à {{ task.creation_date|date:"H:i" }} par <b>{{ task.owner }}</b>
                                    </span>
                                </div>
                                <hr>
                                <div class="fullwidth" id="description_{{ task.task_no }}">
                                    {{ task.description|linebreaks|display_urls }}
                                </div>
                                <hr>
                                <div class="margint-normal followups_container" id="followups_{{ task.task_no }}">
                                {% for followup in followups|get_value:task.task_no %}
                                    <div class="marginb-normal single_followup">
                                {% if followup.f_type == followup.COMMENT %}
                                    <div class="followup_header b_grey">
                                        <b>{{ followup.writer }}</b> a commenté le {{ followup.creation_date|date:"d/m/Y" }} à {{ followup.creation_date|date:"H:i"  }} :
                                    </div>
                                    <div style="padding: 0.8em;">
                                        {{ followup.content|linebreaks|display_urls }}
                                    </div>
                                {% else %}
                                {% if followup.f_type == followup.STATE_CHANGE %}
                                    <div class="followup_header b_grey">
                                        <b>{{ followup.writer }}</b> a changé la priorité de 
                                        "{{ priority_levels|get_value_from_tuple_list:followup.old_priority }}" à
                                            "{{ priority_levels|get_value_from_tuple_list:followup.new_priority }}". 
                                    </div>
                                    <div style="padding: 0.8em;">
                                            {{ followup.content|display_urls|linebreaks }}
                                    </div>
                                {% else %}
                                    <div class="update_header b_grey">
                                        <b>{{ followup.writer }}</b> a mis à jour la tâche le {{ followup.creation_date|date:"d/m/Y à H:i" }}
                                    </div>
                                {% endif %}
                                {% endif %}
                                    </div>
                                {% endfor %}
                                </div>
                                <button type="button" id="edit-btn_{{ task.task_no }}" class="marginr-tiny pure-button pure-button-primary">EDITER</button>
                                {% if not task.is_done %}
                                    <button type="button" id="close-btn_{{ task.task_no }}" class="marginl-tiny pure-button pure-button-primary">
                                        FERMER LA TÂCHE
                                    </button>
                                {% else %}
                                    <button type="button" id="close-btn_{{ task.task_no }}" class="marginl-tiny pure-button pure-button-primary">
                                        ROUVRIR LA TÂCHE
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    {% if not xhr %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
{% endblock %}